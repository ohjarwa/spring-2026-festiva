# ç®¡ç†å‘˜åŠŸèƒ½ä½¿ç”¨è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬ç³»ç»Ÿå®ç°äº†å®Œæ•´çš„ç®¡ç†å‘˜æƒé™ä½“ç³»ï¼Œæ”¯æŒï¼š
- âœ… ä½œå“ä¸‹çº¿ï¼ˆç®¡ç†å‘˜åŠä»¥ä¸Šæƒé™ï¼‰
- âœ… è®¾ç½®ç”¨æˆ·ç®¡ç†å‘˜çº§åˆ«ï¼ˆè¶…çº§ç®¡ç†å‘˜æƒé™ï¼‰
- âœ… ç”¨æˆ·å°ç¦ï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
- âœ… å¤šçº§ç®¡ç†å‘˜ä½“ç³»ï¼šæ™®é€šç”¨æˆ· â†’ å®¡æ ¸å‘˜ â†’ ç®¡ç†å‘˜ â†’ è¶…çº§ç®¡ç†å‘˜

---

## ğŸ” æƒé™ç­‰çº§

| çº§åˆ« | code | åç§° | æƒé™è¯´æ˜ |
|-----|------|------|---------|
| æ™®é€šç”¨æˆ· | 0 | USER | åŸºç¡€ä½¿ç”¨æƒé™ |
| å®¡æ ¸å‘˜ | 1 | AUDITOR | å†…å®¹å®¡æ ¸æƒé™ |
| ç®¡ç†å‘˜ | 2 | ADMIN | å¯ä¸‹çº¿ä½œå“ã€å°ç¦ç”¨æˆ· |
| è¶…çº§ç®¡ç†å‘˜ | 3 | SUPER_ADMIN | æ‰€æœ‰æƒé™ï¼Œå¯è®¾ç½®å…¶ä»–ç”¨æˆ·ä¸ºç®¡ç†å‘˜ |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ•°æ®åº“å‡çº§

æ‰§è¡Œä»¥ä¸‹SQLæ·»åŠ ç®¡ç†å‘˜åŠŸèƒ½ï¼š

```bash
mysql -u root -p spring_2026_festival < src/main/resources/sql/admin_upgrade.sql
```

æˆ–æ‰‹åŠ¨æ‰§è¡Œï¼š

```sql
-- æ·»åŠ ç®¡ç†å‘˜çº§åˆ«å­—æ®µ
ALTER TABLE `spring_2026_user`
ADD COLUMN `admin_level` tinyint(4) DEFAULT '0' COMMENT 'ç®¡ç†å‘˜çº§åˆ« 0=æ™®é€šç”¨æˆ· 1=å®¡æ ¸å‘˜ 2=ç®¡ç†å‘˜ 3=è¶…çº§ç®¡ç†å‘˜'
AFTER `extra_data`;

-- åˆ›å»ºè¶…çº§ç®¡ç†å‘˜
INSERT IGNORE INTO `spring_2026_user`
(`user_id`, `activity_type`, `source`, `total_quota`, `used_quota`, `remaining_quota`, `admin_level`)
VALUES
('admin', 1, 'system', 99999, 0, 99999, 3);
```

### 2. è®¾ç½®ç¬¬ä¸€ä¸ªç®¡ç†å‘˜

æ‰§è¡ŒSQLåï¼Œä¼šåˆ›å»ºä¸€ä¸ªuser_idä¸º`admin`çš„è¶…çº§ç®¡ç†å‘˜è´¦å·ã€‚

**é‡è¦**ï¼šè¯·åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç«‹å³ä¿®æ”¹æ­¤è´¦å·çš„å¯†ç ï¼

---

## ğŸ“ APIæ¥å£æ–‡æ¡£

### 1. ä¸‹çº¿ä½œå“

**æ¥å£**ï¼š`POST /admin/works/take-down`

**æƒé™**ï¼šéœ€è¦ç®¡ç†å‘˜æƒé™ï¼ˆadmin_level >= 2ï¼‰

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "recordId": "record_123456",
  "reason": "è¿è§„å†…å®¹ï¼šåŒ…å«ä¸å½“ä¿¡æ¯"
}
```

**Headers**ï¼š
```
X-User-UUID: admin_user_id
```

**å“åº”**ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": null
}
```

**è¯´æ˜**ï¼š
- åªèƒ½ä¸‹çº¿çŠ¶æ€ä¸º"å·²å®Œæˆ"çš„ä½œå“
- ä¸‹çº¿åä½œå“çŠ¶æ€å˜ä¸º"å·²ä¸‹çº¿"ï¼ˆstatus=4ï¼‰
- è®°å½•æ“ä½œäººå’ŒåŸå› åˆ°audit_infoå­—æ®µ

---

### 2. è®¾ç½®ç”¨æˆ·ç®¡ç†å‘˜çº§åˆ«

**æ¥å£**ï¼š`POST /admin/users/set-admin`

**æƒé™**ï¼šéœ€è¦è¶…çº§ç®¡ç†å‘˜æƒé™ï¼ˆadmin_level = 3ï¼‰

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "targetId": "user_123456",
  "adminLevel": 2
}
```

**Headers**ï¼š
```
X-User-UUID: super_admin_id
```

**å“åº”**ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": null
}
```

**è¯´æ˜**ï¼š
- åªèƒ½ç”±è¶…çº§ç®¡ç†å‘˜æ“ä½œ
- ä¸èƒ½é™ä½è‡ªå·±çš„ç®¡ç†å‘˜çº§åˆ«
- æ”¯æŒçš„çº§åˆ«ï¼š0=æ™®é€šç”¨æˆ·, 1=å®¡æ ¸å‘˜, 2=ç®¡ç†å‘˜, 3=è¶…çº§ç®¡ç†å‘˜

---

### 3. å°ç¦ç”¨æˆ·

**æ¥å£**ï¼š`POST /admin/users/ban`

**æƒé™**ï¼šéœ€è¦ç®¡ç†å‘˜æƒé™ï¼ˆadmin_level >= 2ï¼‰

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "targetId": "user_123456",
  "banReason": "å¤šæ¬¡è¿è§„",
  "banDays": 7
}
```

**Headers**ï¼š
```
X-User-UUID: admin_user_id
```

**å“åº”**ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": null
}
```

**è¯´æ˜**ï¼š
- banDays=0 è¡¨ç¤ºæ°¸ä¹…å°ç¦
- banDays>0 è¡¨ç¤ºä¸´æ—¶å°ç¦Nå¤©
- TODOï¼šåŠŸèƒ½å¾…å®Œå–„

---

## ğŸ’» ä»£ç ä½¿ç”¨ç¤ºä¾‹

### åœ¨Controllerä¸­ä½¿ç”¨ç®¡ç†å‘˜æƒé™æ³¨è§£

```java
@RestController
@RequestMapping("/admin")
public class AdminController {

    // æ–¹æ³•çº§åˆ«æ³¨è§£
    @RequireAdmin  // é»˜è®¤éœ€è¦ADMINæƒé™
    @PostMapping("/works/take-down")
    public Result<Void> takeDownWork(@RequestParam String recordId) {
        // ä¸šåŠ¡é€»è¾‘
    }

    // æŒ‡å®šæƒé™çº§åˆ«
    @RequireAdmin(AdminLevel.SUPER_ADMIN)
    @PostMapping("/users/set-admin")
    public Result<Void> setUserAdmin(@RequestParam String targetId) {
        // ä¸šåŠ¡é€»è¾‘
    }
}
```

### æ£€æŸ¥ç”¨æˆ·æƒé™

```java
@Service
public class SomeService {

    @Autowired
    private UserService userService;

    public void doSomething(String userId) {
        // è·å–ç”¨æˆ·ç®¡ç†å‘˜çº§åˆ«
        AdminLevel level = userService.getUserAdminLevel(userId);

        // æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
        if (level.isAdmin()) {
            // ç®¡ç†å‘˜é€»è¾‘
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºè¶…çº§ç®¡ç†å‘˜
        if (level.isSuperAdmin()) {
            // è¶…çº§ç®¡ç†å‘˜é€»è¾‘
        }
    }
}
```

---

## ğŸ”’ å®‰å…¨è¯´æ˜

### 1. æƒé™éªŒè¯æœºåˆ¶

- åŸºäº`X-User-UUID`è¯·æ±‚å¤´è¯†åˆ«ç”¨æˆ·
- æ‹¦æˆªå™¨è‡ªåŠ¨æ£€æŸ¥ç®¡ç†å‘˜æƒé™
- æ”¯æŒ4çº§ç®¡ç†å‘˜ä½“ç³»

### 2. æƒé™æ³¨è§£

`@RequireAdmin`æ³¨è§£å¯ä»¥ç”¨åœ¨ï¼š
- æ–¹æ³•ä¸Šï¼šä¿æŠ¤å•ä¸ªæ¥å£
- ç±»ä¸Šï¼šä¿æŠ¤æ•´ä¸ªController

```java
@RequireAdmin(AdminLevel.SUPER_ADMIN)  // ç±»çº§åˆ«ï¼šæ•´ä¸ªControlleréƒ½éœ€è¦æƒé™
public class SuperAdminController {

    @PostMapping("/sensitive-operation")
    public Result<Void> sensitiveOp() {
        // è¿™ä¸ªæ–¹æ³•ä¼šç»§æ‰¿ç±»çº§åˆ«çš„æƒé™è¦æ±‚
    }
}
```

### 3. æ‹¦æˆªå™¨é…ç½®

æ‹¦æˆªè·¯å¾„ï¼š`/admin/**`

æ’é™¤è·¯å¾„ï¼š`/admin/login`

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡ä½¿ç”¨**
   - æ‰§è¡ŒSQLå‡çº§è„šæœ¬
   - é»˜è®¤åˆ›å»ºçš„è¶…çº§ç®¡ç†å‘˜è´¦å·user_idä¸º`admin`
   - ç”Ÿäº§ç¯å¢ƒè¯·ç«‹å³ä¿®æ”¹æˆ–åˆ é™¤é»˜è®¤è´¦å·

2. **æƒé™æå‡**
   - åªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¾ç½®å…¶ä»–ç”¨æˆ·ä¸ºç®¡ç†å‘˜
   - ä¸èƒ½é™ä½è‡ªå·±çš„æƒé™çº§åˆ«
   - å»ºè®®è‡³å°‘ä¿ç•™2ä¸ªè¶…çº§ç®¡ç†å‘˜è´¦å·

3. **æ“ä½œå®¡è®¡**
   - æ‰€æœ‰ä¸‹çº¿æ“ä½œéƒ½ä¼šè®°å½•æ“ä½œäºº
   - å»ºè®®å®šæœŸæ£€æŸ¥ç®¡ç†å‘˜æ“ä½œæ—¥å¿—

---

## ğŸ“Š æ•°æ®åº“å­—æ®µè¯´æ˜

### spring_2026_userè¡¨

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| admin_level | tinyint(4) | ç®¡ç†å‘˜çº§åˆ« 0=æ™®é€šç”¨æˆ· 1=å®¡æ ¸å‘˜ 2=ç®¡ç†å‘˜ 3=è¶…çº§ç®¡ç†å‘˜ |

### spring_2026_creation_recordè¡¨

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| status | tinyint(4) | 0=æ’é˜Ÿ 1=ç”Ÿæˆä¸­ 2=å·²å®Œæˆ 3=å¤±è´¥ 4=å·²ä¸‹çº¿ |
| audit_info | text | å®¡æ ¸ä¿¡æ¯ï¼ˆJSONæ ¼å¼ï¼‰ï¼Œä¸‹çº¿æ“ä½œæ—¶è®°å½•æ“ä½œäººå’ŒåŸå›  |

---

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

### æµ‹è¯•ä¸‹çº¿åŠŸèƒ½

```bash
# 1. ç¡®ä¿ä½ æ˜¯ç®¡ç†å‘˜ï¼ˆadmin_level >= 2ï¼‰
curl -X POST "http://localhost:8080/api/admin/works/take-down" \
  -H "X-User-UUID: admin" \
  -H "Content-Type: application/json" \
  -d '{
    "recordId": "record_123",
    "reason": "è¿è§„å†…å®¹"
  }'

# å“åº”
{
  "code": 0,
  "message": "success"
}
```

### æµ‹è¯•æƒé™è®¾ç½®

```bash
# åªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥æ‰§è¡Œ
curl -X POST "http://localhost:8080/api/admin/users/set-admin" \
  -H "X-User-UUID: admin" \
  -H "Content-Type: application/json" \
  -d '{
    "targetId": "user_456",
    "adminLevel": 2
  }'
```

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: å¿˜è®°ç®¡ç†å‘˜å¯†ç æ€ä¹ˆåŠï¼Ÿ
A: ç›´æ¥ç™»å½•æ•°æ®åº“ï¼ŒæŸ¥è¯¢æˆ–ä¿®æ”¹user_idä¸º`admin`çš„è®°å½•ã€‚

### Q2: å¦‚ä½•æ·»åŠ æ–°çš„è¶…çº§ç®¡ç†å‘˜ï¼Ÿ
A: ä½¿ç”¨ç°æœ‰çš„è¶…çº§ç®¡ç†å‘˜è´¦å·è°ƒç”¨`/admin/users/set-admin`æ¥å£ã€‚

### Q3: æ™®é€šç”¨æˆ·èƒ½çœ‹åˆ°å·²ä¸‹çº¿çš„ä½œå“å—ï¼Ÿ
A: éœ€è¦åœ¨æŸ¥è¯¢æ¥å£ä¸­è¿‡æ»¤status=4çš„ä½œå“ã€‚å»ºè®®åœ¨WorkControllerä¸­æ·»åŠ è¿‡æ»¤é€»è¾‘ã€‚

---

## ğŸ”œ åç»­ä¼˜åŒ–å»ºè®®

1. **æ“ä½œæ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰ç®¡ç†å‘˜æ“ä½œåˆ°å•ç‹¬çš„æ—¥å¿—è¡¨
2. **äºŒæ¬¡éªŒè¯**ï¼šæ•æ„Ÿæ“ä½œéœ€è¦äºŒæ¬¡éªŒè¯ï¼ˆå¯†ç /éªŒè¯ç ï¼‰
3. **æƒé™ç»†åˆ†**ï¼šæ›´ç»†ç²’åº¦çš„æƒé™æ§åˆ¶ï¼ˆå¦‚åªèƒ½ä¸‹çº¿ç‰¹å®šç±»å‹çš„ä½œå“ï¼‰
4. **æ“ä½œå®¡è®¡**ï¼šæä¾›å¯è§†åŒ–çš„ç®¡ç†å‘˜æ“ä½œå®¡è®¡ç•Œé¢
